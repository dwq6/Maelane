import React, { useState, useRef } from 'react';
import { User, GripVertical, Trash2, Plus, Download, Printer, Users, LayoutGrid, Eraser, Crown, Mic2 } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Alert, AlertDescription } from "@/components/ui/alert";

const SeatingChart = () => {
  // State
  const [rows, setRows] = useState(8);
  const [cols, setCols] = useState(12);
  const [guests, setGuests] = useState([]);
  const [unseatedGuests, setUnseatedGuests] = useState([]);
  const [seats, setSeats] = useState({}); // { "0-0": { guest: null, color: 'default', type: 'desk' } }
  const [draggedItem, setDraggedItem] = useState(null);
  const [newGuestName, setNewGuestName] = useState("");
  const [bulkNames, setBulkNames] = useState("");
  const [selectedColor, setSelectedColor] = useState("bg-white");
  const [editMode, setEditMode] = useState("drag"); // 'drag', 'color', 'aisle'

  // Colors adjusted for business/event context
  const colors = [
    { name: 'æ™®é€šå˜‰å®¾ (ç™½)', value: 'bg-white', border: 'border-gray-200', text: 'text-gray-800' },
    { name: 'æ ¸å¿ƒVIP (çº¢)', value: 'bg-red-100', border: 'border-red-500', text: 'text-red-900' },
    { name: 'è´µå®¾/åˆä½œæ–¹ (ç»¿)', value: 'bg-green-100', border: 'border-green-500', text: 'text-green-900' },
    { name: 'åª’ä½“/å·¥ä½œç»„ (è“)', value: 'bg-blue-100', border: 'border-blue-500', text: 'text-blue-900' },
    { name: 'é¢„ç•™/æœºåŠ¨ (é»„)', value: 'bg-yellow-50', border: 'border-yellow-500', text: 'text-yellow-900' },
  ];

  const handleAddGuest = () => {
    if (!newGuestName.trim()) return;
    const newGuest = { id: Date.now(), name: newGuestName };
    setUnseatedGuests([...unseatedGuests, newGuest]);
    setNewGuestName("");
  };

  const handleBulkImport = () => {
    const names = bulkNames.split(/[\n,ï¼Œ\s]+/).filter(n => n.trim());
    const newGuests = names.map((name, index) => ({
      id: Date.now() + index,
      name: name.trim()
    }));
    setUnseatedGuests([...unseatedGuests, ...newGuests]);
    setBulkNames("");
  };

  // Drag Handlers
  const onDragStart = (e, item, source) => {
    setDraggedItem({ item, source }); // source: 'sidebar' or {r, c}
    e.dataTransfer.effectAllowed = 'move';
  };

  const onDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  };

  const onDrop = (e, targetR, targetC) => {
    e.preventDefault();
    const key = `${targetR}-${targetC}`;
    const targetSeat = seats[key] || { type: 'desk', color: 'bg-white' };
    
    if (targetSeat.type === 'aisle') return;

    const source = draggedItem.source;
    const guest = draggedItem.item;

    const newSeats = { ...seats };
    const newUnseated = [...unseatedGuests];

    const targetGuest = newSeats[key]?.guest;

    // 1. Remove from source
    if (source === 'sidebar') {
      const idx = newUnseated.findIndex(g => g.id === guest.id);
      if (idx > -1) newUnseated.splice(idx, 1);
    } else {
      const sourceKey = `${source.r}-${source.c}`;
      newSeats[sourceKey] = { ...newSeats[sourceKey], guest: targetGuest }; 
    }

    // 2. Add to target
    newSeats[key] = { 
      ...targetSeat, 
      guest: guest,
      color: newSeats[key]?.color || 'bg-white',
      type: 'desk'
    };

    // 3. If target had a guest and source was sidebar, return target to sidebar
    if (targetGuest && source === 'sidebar') {
      newUnseated.push(targetGuest);
    }

    setSeats(newSeats);
    setUnseatedGuests(newUnseated);
    setDraggedItem(null);
  };

  const onDropToSidebar = (e) => {
    e.preventDefault();
    if (draggedItem.source === 'sidebar') return;

    const sourceKey = `${draggedItem.source.r}-${draggedItem.source.c}`;
    const newSeats = { ...seats };
    
    newSeats[sourceKey] = { ...newSeats[sourceKey], guest: null };
    
    setUnseatedGuests([...unseatedGuests, draggedItem.item]);
    setSeats(newSeats);
    setDraggedItem(null);
  };

  const handleSeatClick = (r, c) => {
    const key = `${r}-${c}`;
    const currentSeat = seats[key] || { type: 'desk', color: 'bg-white', guest: null };
    const newSeats = { ...seats };

    if (editMode === 'aisle') {
      newSeats[key] = {
        ...currentSeat,
        type: currentSeat.type === 'desk' ? 'aisle' : 'desk',
        guest: currentSeat.type === 'desk' ? null : currentSeat.guest
      };
      if (currentSeat.type === 'desk' && currentSeat.guest) {
         setUnseatedGuests([...unseatedGuests, currentSeat.guest]);
      }
    } else if (editMode === 'color') {
      if (currentSeat.type === 'aisle') return;
      newSeats[key] = {
        ...currentSeat,
        color: selectedColor
      };
    } else if (editMode === 'delete') {
       if (currentSeat.guest) {
          setUnseatedGuests([...unseatedGuests, currentSeat.guest]);
          newSeats[key] = { ...currentSeat, guest: null };
       }
    }

    setSeats(newSeats);
  };

  const clearAllSeats = () => {
    if(!window.confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åº§ä½ä¸Šçš„å˜‰å®¾å—ï¼Ÿï¼ˆåå•å°†å›åˆ°å¾…åˆ†é…åˆ—è¡¨ï¼‰")) return;
    const newSeats = { ...seats };
    const guestsToReturn = [];
    
    Object.keys(newSeats).forEach(key => {
      if (newSeats[key].guest) {
        guestsToReturn.push(newSeats[key].guest);
        newSeats[key].guest = null;
      }
    });
    
    setSeats(newSeats);
    setUnseatedGuests([...unseatedGuests, ...guestsToReturn]);
  };

  return (
    <div className="flex flex-col h-full w-full max-w-6xl mx-auto p-4 gap-4 bg-slate-50 min-h-screen font-sans">
      
      {/* Header Controls */}
      <Card className="w-full border-t-4 border-t-slate-800 shadow-md">
        <CardHeader className="pb-2">
          <div className="flex justify-between items-center">
            <CardTitle className="flex items-center gap-2 text-slate-800">
              <Crown className="h-6 w-6 text-yellow-600" />
              ä¼šè®®/æ´»åŠ¨å˜‰å®¾æ’åº§ç³»ç»Ÿ
            </CardTitle>
            <div className="flex gap-2">
              <Button variant="outline" size="sm" onClick={() => window.print()}>
                <Printer className="h-4 w-4 mr-2" /> æ‰“å°åº§æ¬¡è¡¨
              </Button>
              <Button variant="destructive" size="sm" onClick={clearAllSeats}>
                <Eraser className="h-4 w-4 mr-2" /> æ¸…ç©ºåº§ä½
              </Button>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <div className="flex flex-wrap gap-4 items-end">
            <div className="flex flex-col gap-1">
              <span className="text-xs font-medium text-gray-500">æ’æ•° (Rows)</span>
              <Input type="number" value={rows} onChange={e => setRows(Number(e.target.value))} className="w-20" min={1} max={30} />
            </div>
            <div className="flex flex-col gap-1">
              <span className="text-xs font-medium text-gray-500">åº§æ•° (Cols)</span>
              <Input type="number" value={cols} onChange={e => setCols(Number(e.target.value))} className="w-20" min={1} max={30} />
            </div>
            
            <div className="h-8 w-[1px] bg-gray-300 mx-2"></div>

            <div className="flex flex-col gap-1">
               <span className="text-xs font-medium text-gray-500">æ“ä½œæ¨¡å¼</span>
               <div className="flex bg-slate-100 p-1 rounded-lg">
                  <button 
                    onClick={() => setEditMode('drag')}
                    className={`px-3 py-1 text-sm rounded-md transition-all flex items-center gap-1 ${editMode === 'drag' ? 'bg-white shadow text-slate-800 font-bold' : 'text-gray-600 hover:bg-gray-200'}`}
                  >
                    âœ‹ å®‰æ’å˜‰å®¾
                  </button>
                  <button 
                    onClick={() => setEditMode('color')}
                    className={`px-3 py-1 text-sm rounded-md transition-all flex items-center gap-1 ${editMode === 'color' ? 'bg-white shadow text-slate-800 font-bold' : 'text-gray-600 hover:bg-gray-200'}`}
                  >
                    ğŸ¨ åŒºåŸŸ/èº«ä»½æ ‡è®°
                  </button>
                  <button 
                    onClick={() => setEditMode('aisle')}
                    className={`px-3 py-1 text-sm rounded-md transition-all flex items-center gap-1 ${editMode === 'aisle' ? 'bg-white shadow text-slate-800 font-bold' : 'text-gray-600 hover:bg-gray-200'}`}
                  >
                    ğŸ›£ï¸ è®¾ç½®è¿‡é“
                  </button>
                   <button 
                    onClick={() => setEditMode('delete')}
                    className={`px-3 py-1 text-sm rounded-md transition-all flex items-center gap-1 ${editMode === 'delete' ? 'bg-white shadow text-red-600 font-bold' : 'text-gray-600 hover:bg-gray-200'}`}
                  >
                    âŒ ç§»é™¤
                  </button>
               </div>
            </div>

            {editMode === 'color' && (
              <div className="flex gap-2 items-center ml-2 animate-in fade-in slide-in-from-left-4 bg-white p-1 rounded-full border px-2">
                {colors.map(c => (
                  <button
                    key={c.value}
                    onClick={() => setSelectedColor(c.value)}
                    className={`w-6 h-6 rounded-full border ${c.value} ${c.border} ${selectedColor === c.value ? 'ring-2 ring-offset-2 ring-slate-400 scale-110' : ''}`}
                    title={c.name}
                  />
                ))}
                <span className="text-xs text-gray-500 ml-1">
                  {colors.find(c => c.value === selectedColor)?.name}
                </span>
              </div>
            )}
          </div>
          {editMode === 'aisle' && <p className="text-xs text-gray-500 mt-2">ç‚¹å‡»æ ¼å­è®¾ç½®è¿‡é“ï¼ˆå†æ¬¡ç‚¹å‡»æ¢å¤åº§ä½ï¼‰</p>}
          {editMode === 'color' && <p className="text-xs text-gray-500 mt-2">ç‚¹å‡»åº§ä½æ ‡è®°å½“å‰é€‰ä¸­çš„èº«ä»½é¢œè‰²</p>}
        </CardContent>
      </Card>

      <div className="flex flex-col lg:flex-row gap-4 flex-1 overflow-hidden">
        {/* Main Seating Area */}
        <div className="flex-1 bg-white border rounded-xl p-8 overflow-auto shadow-sm relative min-h-[600px]">
          {/* Stage Area */}
          <div className="w-2/3 mx-auto h-16 bg-slate-800 rounded-b-3xl mb-12 flex items-center justify-center shadow-lg text-slate-200 mb-16">
             <Mic2 className="mr-2 h-5 w-5" />
             <span className="text-lg font-bold tracking-widest">èˆå° / ä¸»å¸­å° / å±å¹•</span>
          </div>
          
          <div 
            className="grid gap-3 mx-auto pb-20"
            style={{
              gridTemplateColumns: `repeat(${cols}, minmax(70px, 1fr))`,
              width: 'fit-content'
            }}
          >
            {Array.from({ length: rows }).map((_, r) => (
              Array.from({ length: cols }).map((_, c) => {
                const key = `${r}-${c}`;
                const seat = seats[key] || { type: 'desk', color: 'bg-white', guest: null };
                const isAisle = seat.type === 'aisle';
                const colorConfig = colors.find(col => col.value === seat.color) || colors[0];

                return (
                  <div
                    key={key}
                    onClick={() => handleSeatClick(r, c)}
                    onDragOver={onDragOver}
                    onDrop={(e) => onDrop(e, r, c)}
                    draggable={!!seat.guest && editMode === 'drag'}
                    onDragStart={(e) => seat.guest && onDragStart(e, seat.guest, {r, c})}
                    className={`
                      relative h-14 w-full rounded flex items-center justify-center text-sm transition-all
                      ${isAisle ? 'border-transparent bg-transparent' : `${seat.color} ${colorConfig.border} border shadow-sm hover:shadow-md cursor-pointer`}
                      ${editMode === 'aisle' && !isAisle ? 'hover:opacity-50' : ''}
                      ${seat.guest ? colorConfig.text : 'text-gray-300'}
                    `}
                  >
                    {!isAisle && (
                      <>
                        {seat.guest ? (
                          <div className="flex flex-col items-center w-full px-1">
                            <span className="font-bold truncate w-full text-center text-sm leading-tight">{seat.guest.name}</span>
                          </div>
                        ) : (
                          <span className="text-[10px] absolute top-0.5 left-1 opacity-50">{r+1}-{c+1}</span>
                        )}
                      </>
                    )}
                  </div>
                );
              })
            ))}
          </div>
        </div>

        {/* Sidebar: Guest List */}
        <div 
          className="w-full lg:w-80 flex flex-col gap-4"
          onDragOver={onDragOver}
          onDrop={onDropToSidebar}
        >
          <Card className="flex-1 flex flex-col bg-white shadow-sm border-t-4 border-t-slate-600">
            <CardHeader className="py-3 bg-slate-50 border-b">
              <CardTitle className="text-base flex justify-between items-center">
                <span>å¾…å®‰æ’åå• ({unseatedGuests.length})</span>
                <Users className="h-4 w-4 text-gray-500"/>
              </CardTitle>
            </CardHeader>
            <CardContent className="flex-1 flex flex-col p-3 gap-3 overflow-hidden">
              {/* Add Single */}
              <div className="flex gap-2">
                <Input 
                  placeholder="è¾“å…¥å˜‰å®¾å§“å..." 
                  value={newGuestName}
                  onChange={e => setNewGuestName(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && handleAddGuest()}
                  className="bg-white"
                />
                <Button size="icon" onClick={handleAddGuest} className="bg-slate-800 hover:bg-slate-700"><Plus className="h-4 w-4" /></Button>
              </div>

              {/* Bulk Add */}
              <div className="relative group">
                 <Textarea 
                  placeholder="æ‰¹é‡ç²˜è´´åå• (Excelåˆ—ã€é€—å·æˆ–æ¢è¡Œåˆ†éš”)" 
                  className="h-20 text-xs resize-none focus:h-32 transition-all absolute top-0 z-10 bg-white group-hover:h-32 group-focus-within:h-32 shadow-sm"
                  value={bulkNames}
                  onChange={e => setBulkNames(e.target.value)}
                 />
                 <div className="h-20"></div> {/* Spacer */}
                 <Button variant="secondary" size="sm" className="w-full mt-12 z-20 relative border" onClick={handleBulkImport} disabled={!bulkNames}>
                   æ‰¹é‡å¯¼å…¥åå•
                 </Button>
              </div>

              {/* List */}
              <div className="flex-1 overflow-y-auto min-h-[200px] border rounded-md p-2 bg-slate-50">
                {unseatedGuests.length === 0 ? (
                  <div className="text-center text-gray-400 mt-10 text-sm">
                    æš‚æ— å¾…æ’å˜‰å®¾<br/>è¯·å¯¼å…¥æˆ–ä»åº§ä½æ‹–å›
                  </div>
                ) : (
                  <div className="grid grid-cols-2 gap-2">
                    {unseatedGuests.map(guest => (
                      <div
                        key={guest.id}
                        draggable
                        onDragStart={(e) => onDragStart(e, guest, 'sidebar')}
                        className="bg-white p-2 rounded border shadow-sm cursor-move hover:border-slate-400 hover:shadow-md flex items-center justify-between group transition-all"
                      >
                        <span className="truncate text-sm font-medium text-slate-700">{guest.name}</span>
                        <GripVertical className="h-3 w-3 text-gray-300" />
                      </div>
                    ))}
                  </div>
                )}
              </div>
              
              <Alert className="bg-slate-100 border-slate-200 py-2">
                <AlertDescription className="text-xs text-slate-600">
                  ğŸ’¡ æŠ€å·§ï¼šç›´æ¥æ‹–æ‹½å˜‰å®¾Aåˆ°å˜‰å®¾Bçš„ä½ç½®ï¼Œä¸¤äººä¼šè‡ªåŠ¨äº’æ¢ã€‚
                </AlertDescription>
              </Alert>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
};

export default SeatingChart;
