<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨å˜‰å®¾æ™ºèƒ½æ’åº§ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #1e293b;
            --primary-hover: #334155;
            --bg: #f8fafc;
            --border: #e2e8f0;
            --white: #ffffff;
            --red-bg: #fee2e2; --red-border: #ef4444; --red-text: #7f1d1d;
            --green-bg: #dcfce7; --green-border: #22c55e; --green-text: #14532d;
            --blue-bg: #dbeafe; --blue-border: #3b82f6; --blue-text: #1e3a8a;
            --yellow-bg: #fef9c3; --yellow-border: #eab308; --yellow-text: #713f12;
        }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; }
        
        /* Header */
        .header { background: var(--white); padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; border-top: 4px solid var(--primary); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        .controls { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .control-label { font-size: 12px; color: #64748b; font-weight: 600; }
        
        /* Inputs & Buttons */
        input[type="number"] { padding: 6px; border: 1px solid var(--border); border-radius: 4px; width: 60px; }
        input[type="text"] { padding: 8px; border: 1px solid var(--border); border-radius: 4px; flex: 1; }
        textarea { padding: 8px; border: 1px solid var(--border); border-radius: 4px; width: 100%; height: 80px; resize: none; font-family: inherit; box-sizing: border-box;}
        button { cursor: pointer; padding: 6px 12px; border: 1px solid var(--border); background: var(--white); border-radius: 4px; font-size: 14px; transition: all 0.2s; }
        button:hover { background: #f1f5f9; }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.primary:hover { background: var(--primary-hover); }
        button.danger { color: #ef4444; border-color: #fee2e2; background: #fef2f2; }
        button.danger:hover { background: #fee2e2; }
        
        /* Mode Switcher */
        .mode-group { display: flex; background: #f1f5f9; padding: 4px; border-radius: 6px; gap: 2px; }
        .mode-btn { border: none; background: transparent; padding: 6px 10px; font-size: 13px; color: #64748b; }
        .mode-btn.active { background: var(--white); color: var(--primary); font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        /* Color Picker */
        .color-picker { display: flex; gap: 8px; align-items: center; margin-left: 10px; padding: 4px 8px; background: white; border: 1px solid var(--border); border-radius: 20px; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); transition: transform 0.2s; }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.selected { transform: scale(1.2); box-shadow: 0 0 0 2px var(--primary); }
        
        /* Main Layout */
        .main-container { display: flex; gap: 20px; flex: 1; overflow: hidden; }
        
        /* Stage & Grid */
        .stage-area { flex: 1; background: var(--white); border-radius: 8px; border: 1px solid var(--border); padding: 20px; overflow: auto; display: flex; flex-direction: column; align-items: center; position: relative; }
        .stage-label { width: 60%; background: var(--primary); color: #cbd5e1; text-align: center; padding: 10px; border-radius: 0 0 20px 20px; margin-bottom: 40px; font-weight: bold; letter-spacing: 2px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .grid-container { display: grid; gap: 8px; margin-bottom: 50px; }
        
        .seat { 
            height: 50px; border-radius: 4px; border: 1px solid #cbd5e1; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 12px; position: relative; user-select: none; transition: all 0.2s;
            background: var(--white);
        }
        .seat:hover { box-shadow: 0 2px 5px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .seat.aisle { border: none; background: transparent !important; pointer-events: none; }
        .seat.aisle.editable { pointer-events: auto; opacity: 0.3; border: 1px dashed #cbd5e1; }
        .seat.aisle.editable:hover { opacity: 0.8; background: #f1f5f9 !important; }
        
        .seat-content { width: 100%; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 4px; font-weight: bold; }
        .seat-coord { position: absolute; top: 2px; left: 4px; font-size: 9px; color: #94a3b8; }
        
        /* Colors */
        .bg-white { background: var(--white); color: #333; }
        .bg-red { background: var(--red-bg); border-color: var(--red-border); color: var(--red-text); }
        .bg-green { background: var(--green-bg); border-color: var(--green-border); color: var(--green-text); }
        .bg-blue { background: var(--blue-bg); border-color: var(--blue-border); color: var(--blue-text); }
        .bg-yellow { background: var(--yellow-bg); border-color: var(--yellow-border); color: var(--yellow-text); }
        
        /* Sidebar */
        .sidebar { width: 300px; background: var(--white); border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; border-top: 4px solid #475569; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); background: #f8fafc; font-weight: bold; display: flex; justify-content: space-between; }
        .sidebar-content { padding: 15px; flex: 1; overflow: hidden; display: flex; flex-direction: column; gap: 15px; }
        
        .add-box { display: flex; gap: 5px; }
        .guest-list { flex: 1; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 8px; background: #f8fafc; }
        .guest-item { 
            background: var(--white); padding: 8px 12px; margin-bottom: 6px; border-radius: 4px; 
            border: 1px solid var(--border); cursor: grab; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .guest-item:hover { border-color: var(--blue-border); }
        .guest-item:active { cursor: grabbing; }
        
        .hint { font-size: 11px; color: #64748b; background: #eff6ff; padding: 8px; border-radius: 4px; border: 1px solid #dbeafe; }

        @media print {
            .sidebar, .controls, .header-top button, .stage-label { display: none; }
            .header { border: none; shadow: none; }
            .stage-area { border: none; }
            body { background: white; height: auto; overflow: visible; }
            .seat { border-color: #94a3b8 !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-top">
        <div class="title">ğŸ‘‘ ä¼šè®®/æ´»åŠ¨å˜‰å®¾æ’åº§ç³»ç»Ÿ</div>
        <div style="display: flex; gap: 10px;">
            <button onclick="window.print()">ğŸ–¨ï¸ æ‰“å°/ä¿å­˜PDF</button>
            <button class="danger" onclick="clearAllSeats()">ğŸ—‘ï¸ æ¸…ç©ºåº§ä½</button>
        </div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <span class="control-label">è¡Œæ•°</span>
            <input type="number" id="rowsInput" value="8" min="1" max="30" onchange="updateGridSize()">
        </div>
        <div class="control-group">
            <span class="control-label">åˆ—æ•°</span>
            <input type="number" id="colsInput" value="12" min="1" max="30" onchange="updateGridSize()">
        </div>
        
        <div style="width: 1px; height: 30px; background: #e2e8f0; margin: 0 10px;"></div>

        <div class="control-group">
            <span class="control-label">æ“ä½œæ¨¡å¼</span>
            <div class="mode-group">
                <button class="mode-btn active" onclick="setMode('drag', this)">âœ‹ å®‰æ’å˜‰å®¾</button>
                <button class="mode-btn" onclick="setMode('color', this)">ğŸ¨ èº«ä»½æ ‡è®°</button>
                <button class="mode-btn" onclick="setMode('aisle', this)">ğŸ›£ï¸ è®¾ç½®è¿‡é“</button>
                <button class="mode-btn" onclick="setMode('delete', this)">âŒ ç§»é™¤</button>
            </div>
        </div>

        <div class="color-picker" id="colorPicker" style="display: none;">
            <div class="color-dot bg-white selected" onclick="setColor('bg-white', this)" title="æ™®é€š"></div>
            <div class="color-dot bg-red" onclick="setColor('bg-red', this)" title="VIP (çº¢)"></div>
            <div class="color-dot bg-green" onclick="setColor('bg-green', this)" title="è´µå®¾ (ç»¿)"></div>
            <div class="color-dot bg-blue" onclick="setColor('bg-blue', this)" title="å·¥ä½œç»„ (è“)"></div>
            <div class="color-dot bg-yellow" onclick="setColor('bg-yellow', this)" title="é¢„ç•™ (é»„)"></div>
        </div>
    </div>
</div>

<div class="main-container">
    <!-- Stage Area -->
    <div class="stage-area">
        <div class="stage-label">èˆå° / ä¸»å¸­å° / å±å¹•</div>
        <div id="gridContainer" class="grid-container"></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span>å¾…å®‰æ’åå• (<span id="unseatedCount">0</span>)</span>
        </div>
        <div class="sidebar-content">
            <div class="add-box">
                <input type="text" id="newGuestName" placeholder="è¾“å…¥å§“å..." onkeypress="if(event.key==='Enter') addGuest()">
                <button class="primary" onclick="addGuest()">+</button>
            </div>
            
            <div>
                <textarea id="bulkInput" placeholder="æ‰¹é‡ç²˜è´´åå• (æ”¯æŒExcelåˆ—å¤åˆ¶ã€é€—å·æˆ–æ¢è¡Œåˆ†éš”)"></textarea>
                <button onclick="bulkImport()" style="width: 100%; margin-top: 5px;">æ‰¹é‡å¯¼å…¥</button>
            </div>

            <div class="guest-list" id="guestList" ondragover="allowDrop(event)" ondrop="dropToSidebar(event)">
                <!-- Guest Items will go here -->
            </div>

            <div class="hint">
                ğŸ’¡ æç¤ºï¼šç›´æ¥æ‹–æ‹½å˜‰å®¾Aåˆ°å˜‰å®¾Bçš„ä½ç½®ï¼Œä¸¤äººä¼šè‡ªåŠ¨äº’æ¢ã€‚
            </div>
        </div>
    </div>
</div>

<script>
    // State
    let state = {
        rows: 8,
        cols: 12,
        mode: 'drag', // drag, color, aisle, delete
        selectedColor: 'bg-white',
        seats: {}, // key: "r-c", val: { guest: {id, name}, type: 'desk'|'aisle', color: 'class' }
        unseated: [] // Array of {id, name}
    };

    let draggedItem = null; // { type: 'sidebar'|'seat', data: guestObj, sourceKey: 'r-c'|null }

    // Init
    function init() {
        renderGrid();
        renderSidebar();
    }

    // --- Rendering ---

    function updateGridSize() {
        state.rows = parseInt(document.getElementById('rowsInput').value) || 5;
        state.cols = parseInt(document.getElementById('colsInput').value) || 8;
        renderGrid();
    }

    function renderGrid() {
        const container = document.getElementById('gridContainer');
        container.style.gridTemplateColumns = `repeat(${state.cols}, 70px)`;
        container.innerHTML = '';

        for (let r = 0; r < state.rows; r++) {
            for (let c = 0; c < state.cols; c++) {
                const key = `${r}-${c}`;
                // Ensure seat object exists
                if (!state.seats[key]) {
                    state.seats[key] = { type: 'desk', color: 'bg-white', guest: null };
                }
                const seatData = state.seats[key];
                
                const seatEl = document.createElement('div');
                seatEl.className = `seat ${seatData.color}`;
                if (seatData.type === 'aisle') {
                    seatEl.classList.add('aisle');
                    if (state.mode === 'aisle') seatEl.classList.add('editable');
                }

                // Content
                if (seatData.type !== 'aisle') {
                    seatEl.innerHTML = `<span class="seat-coord">${r+1}-${c+1}</span>`;
                    if (seatData.guest) {
                        seatEl.innerHTML += `<div class="seat-content">${seatData.guest.name}</div>`;
                        seatEl.draggable = state.mode === 'drag';
                        seatEl.ondragstart = (e) => handleDragStart(e, seatData.guest, 'seat', key);
                    }
                }

                // Events
                seatEl.onclick = () => handleSeatClick(r, c);
                seatEl.ondragover = allowDrop;
                seatEl.ondrop = (e) => handleDrop(e, r, c);

                container.appendChild(seatEl);
            }
        }
    }

    function renderSidebar() {
        const list = document.getElementById('guestList');
        document.getElementById('unseatedCount').innerText = state.unseated.length;
        list.innerHTML = '';

        if (state.unseated.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#94a3b8; font-size:12px; margin-top:20px;">æš‚æ— å¾…æ’å˜‰å®¾</div>';
            return;
        }

        state.unseated.forEach(guest => {
            const item = document.createElement('div');
            item.className = 'guest-item';
            item.draggable = true;
            item.innerHTML = `<span>${guest.name}</span> <span style="color:#cbd5e1">â˜°</span>`;
            item.ondragstart = (e) => handleDragStart(e, guest, 'sidebar', null);
            list.appendChild(item);
        });
    }

    // --- Logic ---

    function setMode(mode, btn) {
        state.mode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.getElementById('colorPicker').style.display = mode === 'color' ? 'flex' : 'none';
        
        // Re-render to update draggable states and aisle visuals
        renderGrid();
    }

    function setColor(colorClass, dot) {
        state.selectedColor = colorClass;
        document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
        dot.classList.add('selected');
    }

    function handleSeatClick(r, c) {
        const key = `${r}-${c}`;
        const seat = state.seats[key];

        if (state.mode === 'aisle') {
            // Toggle aisle
            if (seat.type === 'desk') {
                // If there is a guest, move back to list
                if (seat.guest) {
                    state.unseated.push(seat.guest);
                    seat.guest = null;
                }
                seat.type = 'aisle';
            } else {
                seat.type = 'desk';
            }
        } else if (state.mode === 'color') {
            if (seat.type === 'aisle') return;
            seat.color = state.selectedColor;
        } else if (state.mode === 'delete') {
            if (seat.guest) {
                state.unseated.push(seat.guest);
                seat.guest = null;
            }
        }

        renderGrid();
        renderSidebar();
    }

    // --- Drag & Drop ---

    function handleDragStart(e, guest, type, sourceKey) {
        draggedItem = { guest, type, sourceKey };
        e.dataTransfer.effectAllowed = 'move';
        // e.dataTransfer.setData('text/plain', JSON.stringify(guest)); // Not strictly needed with global var
    }

    function allowDrop(e) {
        e.preventDefault();
    }

    function handleDrop(e, r, c) {
        e.preventDefault();
        if (!draggedItem) return;

        const targetKey = `${r}-${c}`;
        const targetSeat = state.seats[targetKey];

        if (targetSeat.type === 'aisle') return;

        const sourceGuest = draggedItem.guest;
        const targetGuest = targetSeat.guest; // Might be null

        // Logic:
        // 1. Remove sourceGuest from old location
        if (draggedItem.type === 'sidebar') {
            state.unseated = state.unseated.filter(g => g.id !== sourceGuest.id);
        } else {
            // Source was a seat
            state.seats[draggedItem.sourceKey].guest = targetGuest; // Swap! Put target guest in source seat
        }

        // 2. Put sourceGuest in new location
        // If target had a guest, and source was sidebar, target guest goes to sidebar
        if (targetGuest && draggedItem.type === 'sidebar') {
            state.unseated.push(targetGuest);
        }
        
        targetSeat.guest = sourceGuest;

        draggedItem = null;
        renderGrid();
        renderSidebar();
    }

    function dropToSidebar(e) {
        e.preventDefault();
        if (!draggedItem || draggedItem.type === 'sidebar') return;

        // Remove from seat
        state.seats[draggedItem.sourceKey].guest = null;
        // Add to list
        state.unseated.push(draggedItem.guest);

        draggedItem = null;
        renderGrid();
        renderSidebar();
    }

    // --- Data Management ---

    function addGuest() {
        const input = document.getElementById('newGuestName');
        const name = input.value.trim();
        if (!name) return;

        state.unseated.push({ id: Date.now(), name });
        input.value = '';
        renderSidebar();
    }

    function bulkImport() {
        const input = document.getElementById('bulkInput');
        const raw = input.value;
        if (!raw.trim()) return;

        const names = raw.split(/[\n,ï¼Œ\s]+/).filter(n => n.trim());
        names.forEach((n, i) => {
            state.unseated.push({ id: Date.now() + i, name: n });
        });

        input.value = '';
        renderSidebar();
    }

    function clearAllSeats() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åº§ä½ä¸Šçš„å˜‰å®¾å—ï¼Ÿä»–ä»¬å°†å›åˆ°å¾…åˆ†é…åˆ—è¡¨ã€‚')) return;
        
        Object.values(state.seats).forEach(seat => {
            if (seat.guest) {
                state.unseated.push(seat.guest);
                seat.guest = null;
            }
        });
        renderGrid();
        renderSidebar();
    }

    // Start
    init();

</script>
</body>
</html>
