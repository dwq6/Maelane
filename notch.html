<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>梅兰清口编辑器 v2.2</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        // --- 图标 ---
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>;
        const IconImage = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>;

        // --- UI 组件 ---
        const Card = ({ children, className }) => <div className={`bg-white rounded-lg border shadow-sm ${className}`}>{children}</div>;
        const Label = ({ children, className }) => <label className={`text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 ${className}`}>{children}</label>;
        const Input = ({ className, ...props }) => <input className={`flex h-9 w-full rounded-md border border-gray-300 bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-gray-400 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-gray-950 disabled:cursor-not-allowed disabled:opacity-50 ${className}`} {...props} />;
        const Select = ({ value, onChange, options }) => (
            <div className="relative">
                <select value={value} onChange={onChange} className="flex h-9 w-full items-center justify-between rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 appearance-none">
                    {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                </select>
                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                    <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </div>
        );
        const Button = ({ children, className, onClick, variant = "primary" }) => {
            const variants = {
                primary: "bg-green-600 hover:bg-green-700 text-white",
                outline: "border border-gray-300 bg-white hover:bg-gray-100 text-gray-700",
                blue: "bg-blue-600 hover:bg-blue-700 text-white"
            };
            return (
                <button onClick={onClick} className={`inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-gray-950 disabled:pointer-events-none disabled:opacity-50 h-9 px-4 py-2 shadow hover:bg-opacity-90 ${variants[variant]} ${className}`}>{children}</button>
            );
        };
        const Switch = ({ checked, onCheckedChange }) => (
            <button type="button" onClick={() => onCheckedChange(!checked)} className={`peer inline-flex h-[20px] w-[36px] shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-950 focus-visible:ring-offset-2 focus-visible:ring-offset-white disabled:cursor-not-allowed disabled:opacity-50 ${checked ? 'bg-green-600' : 'bg-gray-200'}`}>
                <span className={`pointer-events-none block h-4 w-4 rounded-full bg-white shadow-lg ring-0 transition-transform ${checked ? 'translate-x-4' : 'translate-x-0'}`}></span>
            </button>
        );

        // --- 主程序 ---
        const CleatGenerator = () => {
            const [params, setParams] = useState({
                totalWidth: 130,
                totalThickness: 30,
                stepWidth: 50,
                stepDepth: 10,
                widthLabel: "W", // W 或 L
            });

            const [isBackCleat, setIsBackCleat] = useState(false);

            const [toggles, setToggles] = useState({
                leftFace: true,
                stepFace: true,
                stepRiser: true,
                topFace: true
            });

            const [fileName, setFileName] = useState("清口截面图");
            const svgRef = useRef(null);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setParams(prev => ({ ...prev, [name]: name === 'widthLabel' ? value : Number(value) }));
            };

            const handleToggle = (key) => {
                setToggles(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const generatePath = () => {
                const { totalWidth: W, totalThickness: H, stepWidth: Sw, stepDepth: Sd } = params;
                if (isBackCleat) {
                    return `M ${W} 0 L 0 0 L 0 ${H - Sd} L ${Sw} ${H - Sd} L ${Sw} ${H} L ${W} ${H} Z`;
                } else {
                    return `M ${W} 0 L ${Sw} 0 L ${Sw} ${Sd} L 0 ${Sd} L 0 ${H} L ${W} ${H} Z`;
                }
            };

            const downloadJpg = () => {
                const svgElement = svgRef.current;
                if (!svgElement) return;
                const serializer = new XMLSerializer();
                let source = serializer.serializeToString(svgElement);
                if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
                    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                const viewBoxAttr = svgElement.getAttribute('viewBox').split(' ').map(Number);
                const [vbX, vbY, vbW, vbH] = viewBoxAttr;
                const scale = 3; 
                canvas.width = vbW * scale;
                canvas.height = vbH * scale;
                const svgBlob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
                const url = URL.createObjectURL(svgBlob);
                img.onload = () => {
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const link = document.createElement("a");
                    link.href = canvas.toDataURL('image/jpeg', 1.0);
                    const prefix = isBackCleat ? "背面_" : "";
                    link.download = `${prefix}${fileName.trim() || "section"}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                };
                img.src = url;
            };

            const Defs = () => (
                <defs>
                    <marker id="dot-red" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto" markerUnits="strokeWidth">
                        <circle cx="4" cy="4" r="2.5" fill="red" />
                    </marker>
                    <pattern id="hatch" patternUnits="userSpaceOnUse" width="8" height="8" patternTransform="rotate(45)">
                        <line x1="0" y1="0" x2="0" y2="8" stroke="#000" strokeWidth="1" />
                    </pattern>
                </defs>
            );

            // --- 修复后的 Dimension 组件 ---
            const Dimension = ({ x1, y1, x2, y2, text, offset = 20, vertical = false, color = "red", noExtLines = false }) => {
                const gap = 2; // 延伸线起点距离物体的间隙
                const ext = 5; // 延伸线超过尺寸线的长度
                
                let lx1, ly1, lx2, ly2; 
                let tx, ty; 
                
                // 延伸线坐标
                let extLine1 = { x1: 0, y1: 0, x2: 0, y2: 0 };
                let extLine2 = { x1: 0, y1: 0, x2: 0, y2: 0 };

                if (vertical) {
                    // 垂直标注逻辑 (假设 offset > 0 向左)
                    lx1 = x1 - offset; ly1 = y1;
                    lx2 = x2 - offset; ly2 = y2;
                    tx = lx1 - 4; ty = (y1 + y2) / 2;
                    
                    // 垂直延伸线 (水平方向)
                    const dir = offset > 0 ? -1 : 1; // 向左为负方向
                    extLine1 = { x1: x1 + (gap * dir), y1: y1, x2: lx1 + (ext * dir), y2: y1 };
                    extLine2 = { x1: x2 + (gap * dir), y1: y2, x2: lx2 + (ext * dir), y2: y2 };

                } else {
                    // 水平标注逻辑
                    lx1 = x1; ly1 = y1 - offset;
                    lx2 = x2; ly2 = y2 - offset;
                    tx = (x1 + x2) / 2; 

                    if (offset > 0) {
                        // 标注在上方
                        ty = ly1 - 4;
                        // 延伸线向上
                        extLine1 = { x1: x1, y1: y1 - gap, x2: x1, y2: ly1 - ext };
                        extLine2 = { x1: x2, y1: y2 - gap, x2: x2, y2: ly2 - ext };
                    } else {
                        // 标注在下方 (offset 为负)
                        ty = ly1 + 14;
                        // 延伸线向下：起点是 y + gap，终点是 ly + ext (注意 ly 已经是 y - offset，即 y + abs(offset))
                        extLine1 = { x1: x1, y1: y1 + gap, x2: x1, y2: ly1 + ext };
                        extLine2 = { x1: x2, y1: y2 + gap, x2: x2, y2: ly2 + ext };
                    }
                }

                return (
                    <g>
                        {!noExtLines && (
                            <>
                                <line {...extLine1} stroke={color} strokeWidth="0.5" />
                                <line {...extLine2} stroke={color} strokeWidth="0.5" />
                            </>
                        )}
                        <line x1={lx1} y1={ly1} x2={lx2} y2={ly2} stroke={color} strokeWidth="0.5" markerStart="url(#dot-red)" markerEnd="url(#dot-red)" />
                        <text x={tx} y={ty} fill={color} fontSize="12" textAnchor={vertical ? "end" : "middle"} alignmentBaseline={vertical ? "middle" : "baseline"}>{text}</text>
                    </g>
                );
            };

            const DatumTriangle = ({ x, y, direction }) => {
                const size = 6; 
                const gap = 2;  
                let points = "";
                
                if (direction === 'down') {
                    const tipY = y - gap;
                    points = `${x},${tipY} ${x-size/2},${tipY-size} ${x+size/2},${tipY-size}`;
                } else if (direction === 'up') {
                    const tipY = y + gap;
                    points = `${x},${tipY} ${x-size/2},${tipY+size} ${x+size/2},${tipY+size}`;
                } else if (direction === 'right') {
                    const tipX = x - gap;
                    points = `${tipX},${y} ${tipX-size},${y-size/2} ${tipX-size},${y+size/2}`;
                }
                return <polygon points={points} fill="black" />;
            };

            const padding = { top: 60, right: 60, bottom: 50, left: 80 }; 
            const viewBoxW = params.totalWidth + padding.left + padding.right;
            const viewBoxH = params.totalThickness + padding.top + padding.bottom;
            const remThickness = params.totalThickness - params.stepDepth;

            return (
                <div className="flex flex-col lg:flex-row gap-4 p-4 w-full max-w-6xl mx-auto">
                    {/* 控制面板 */}
                    <Card className="w-full lg:w-1/3 h-fit p-4">
                        <div className="pb-4 border-b mb-4">
                            <h2 className="flex items-center gap-2 text-lg font-semibold"><IconSettings /> 参数设置</h2>
                        </div>
                        <div className="space-y-5">
                            <div className="bg-indigo-50 p-3 rounded border border-indigo-100 flex items-center justify-between">
                                <div className="flex flex-col">
                                    <Label className="text-indigo-900 font-bold">清口位置</Label>
                                    <span className="text-xs text-indigo-600">{isBackCleat ? "背面 (底部)" : "正面 (顶部)"}</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className={`text-sm ${!isBackCleat ? 'font-bold text-indigo-700' : 'text-gray-400'}`}>正面</span>
                                    <Switch checked={isBackCleat} onCheckedChange={setIsBackCleat} />
                                    <span className={`text-sm ${isBackCleat ? 'font-bold text-indigo-700' : 'text-gray-400'}`}>背面</span>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div><Label className="mb-1.5 block">总宽度</Label><Input type="number" name="totalWidth" value={params.totalWidth} onChange={handleChange} /></div>
                                <div><Label className="mb-1.5 block">总厚度 (T)</Label><Input type="number" name="totalThickness" value={params.totalThickness} onChange={handleChange} /></div>
                                <div><Label className="mb-1.5 block">清口宽 (Step W)</Label><Input type="number" name="stepWidth" value={params.stepWidth} onChange={handleChange} /></div>
                                <div><Label className="mb-1.5 block">清口深 (Step D)</Label><Input type="number" name="stepDepth" value={params.stepDepth} onChange={handleChange} /></div>
                            </div>

                            <div className="bg-blue-50 p-3 rounded border border-blue-100">
                                <Label className="mb-2 block text-blue-800">总宽标注文字</Label>
                                <Select 
                                    value={params.widthLabel} 
                                    onChange={(e) => setParams({...params, widthLabel: e.target.value})}
                                    options={[{value: "W", label: "W"}, {value: "L", label: "L"}]}
                                />
                            </div>

                            <div className="bg-gray-50 p-3 rounded border space-y-3">
                                <Label className="block font-bold text-gray-700 mb-2">加工符号(三角)开关</Label>
                                <div className="grid grid-cols-2 gap-y-3 gap-x-4">
                                    <div className="flex items-center justify-between">
                                        <Label className="text-xs">左端面</Label>
                                        <Switch checked={toggles.leftFace} onCheckedChange={() => handleToggle('leftFace')} />
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <Label className="text-xs">清口平面</Label>
                                        <Switch checked={toggles.stepFace} onCheckedChange={() => handleToggle('stepFace')} />
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <Label className="text-xs">清口立面</Label>
                                        <Switch checked={toggles.stepRiser} onCheckedChange={() => handleToggle('stepRiser')} />
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <Label className="text-xs">顶面</Label>
                                        <Switch checked={toggles.topFace} onCheckedChange={() => handleToggle('topFace')} />
                                    </div>
                                </div>
                            </div>

                            <div className="pt-4 border-t space-y-3">
                                <div>
                                    <Label className="mb-1.5 block">导出文件名</Label>
                                    <Input type="text" value={fileName} onChange={(e) => setFileName(e.target.value)} />
                                </div>
                                <Button className="w-full" onClick={downloadJpg}>
                                    <span className="mr-2"><IconImage /></span> 下载 JPG
                                </Button>
                            </div>
                        </div>
                    </Card>

                    {/* 预览区域 */}
                    <Card className="w-full lg:w-2/3 bg-white p-0 overflow-hidden flex flex-col min-h-[500px]">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h2 className="text-lg font-semibold">预览</h2>
                            <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                {isBackCleat ? "背面清口模式" : "正面清口模式"}
                            </span>
                        </div>
                        <div className="flex-grow flex justify-center items-center p-4 bg-gray-50">
                            <div className="border rounded-md bg-white w-full shadow-sm overflow-hidden">
                                <svg 
                                    ref={svgRef}
                                    width="100%" 
                                    viewBox={`${-padding.left} ${-padding.top} ${viewBoxW} ${viewBoxH}`}
                                    style={{ fontFamily: 'Arial, sans-serif' }}
                                >
                                    <Defs />
                                    <path d={generatePath()} fill="url(#hatch)" stroke="black" strokeWidth="1.5" />

                                    {/* 1. 总宽 W/L */}
                                    {/* 调整：背面模式下，Offset 减小到 20 (W太往上) */}
                                    <Dimension x1={0} y1={0} x2={params.totalWidth} y2={0} offset={isBackCleat ? 20 : 35} text={params.widthLabel} />
                                    
                                    {/* 2. 清口宽 50 */}
                                    {isBackCleat ? (
                                        // 背面模式：标注在底部，Offset -15
                                        <Dimension x1={0} y1={params.totalThickness} x2={params.stepWidth} y2={params.totalThickness} offset={-15} text={params.stepWidth} />
                                    ) : (
                                        // 正面模式：标注在顶部，Offset 减小到 15 (50太往上)
                                        <Dimension x1={0} y1={0} x2={params.stepWidth} y2={0} offset={15} text={params.stepWidth} />
                                    )}

                                    {/* 3. 左侧厚度 */}
                                    {isBackCleat ? (
                                        <Dimension x1={0} y1={0} x2={0} y2={remThickness} offset={30} vertical={true} text={remThickness} />
                                    ) : (
                                        <Dimension x1={0} y1={params.stepDepth} x2={0} y2={params.totalThickness} offset={30} vertical={true} text={remThickness} />
                                    )}

                                    {/* 4. 右侧总厚度 */}
                                    <g>
                                        <line x1={params.totalWidth} y1={0} x2={params.totalWidth + 35} y2={0} stroke="red" strokeWidth="0.5" />
                                        <line x1={params.totalWidth} y1={params.totalThickness} x2={params.totalWidth + 35} y2={params.totalThickness} stroke="red" strokeWidth="0.5" />
                                        <line x1={params.totalWidth + 30} y1={0} x2={params.totalWidth + 30} y2={params.totalThickness} stroke="red" strokeWidth="0.5" markerStart="url(#dot-red)" markerEnd="url(#dot-red)" />
                                        <text x={params.totalWidth + 45} y={params.totalThickness/2} fill="red" fontSize="12" textAnchor="middle" alignmentBaseline="middle" transform={`rotate(-90, ${params.totalWidth + 45}, ${params.totalThickness/2})`}>{params.totalThickness}T</text>
                                    </g>

                                    {/* 5. 清口深 10 */}
                                    <g>
                                        {isBackCleat ? (
                                            <>
                                                <line x1={params.stepWidth} y1={remThickness} x2={params.stepWidth + 20} y2={remThickness} stroke="red" strokeWidth="0.5" />
                                                <line x1={params.stepWidth} y1={params.totalThickness} x2={params.stepWidth + 20} y2={params.totalThickness} stroke="red" strokeWidth="0.5" />
                                                <line x1={params.stepWidth + 15} y1={remThickness} x2={params.stepWidth + 15} y2={params.totalThickness} stroke="red" strokeWidth="0.5" markerStart="url(#dot-red)" markerEnd="url(#dot-red)" />
                                                <text 
                                                    x={params.stepWidth + 22} 
                                                    y={(remThickness + params.totalThickness)/2} 
                                                    fill="red" 
                                                    fontSize="10" 
                                                    textAnchor="middle" 
                                                    alignmentBaseline="middle"
                                                    transform={`rotate(-90, ${params.stepWidth + 22}, ${(remThickness + params.totalThickness)/2})`}
                                                >
                                                    {params.stepDepth}
                                                </text>
                                            </>
                                        ) : (
                                            <>
                                                <line x1={params.stepWidth} y1={0} x2={params.stepWidth + 20} y2={0} stroke="red" strokeWidth="0.5" />
                                                <line x1={params.stepWidth} y1={params.stepDepth} x2={params.stepWidth + 20} y2={params.stepDepth} stroke="red" strokeWidth="0.5" />
                                                <line x1={params.stepWidth + 15} y1={0} x2={params.stepWidth + 15} y2={params.stepDepth} stroke="red" strokeWidth="0.5" markerStart="url(#dot-red)" markerEnd="url(#dot-red)" />
                                                <text 
                                                    x={params.stepWidth + 22} 
                                                    y={params.stepDepth/2} 
                                                    fill="red" 
                                                    fontSize="10" 
                                                    textAnchor="middle" 
                                                    alignmentBaseline="middle"
                                                    transform={`rotate(-90, ${params.stepWidth + 22}, ${params.stepDepth/2})`}
                                                >
                                                    {params.stepDepth}
                                                </text>
                                            </>
                                        )}
                                    </g>

                                    {/* 加工符号 */}
                                    {toggles.leftFace && (
                                        isBackCleat 
                                        ? <DatumTriangle x={0} y={remThickness/2} direction="right" />
                                        : <DatumTriangle x={0} y={(params.stepDepth + params.totalThickness)/2} direction="right" />
                                    )}
                                    {toggles.stepFace && (
                                        isBackCleat
                                        ? <DatumTriangle x={params.stepWidth/2} y={remThickness} direction="up" />
                                        : <DatumTriangle x={params.stepWidth/2} y={params.stepDepth} direction="down" />
                                    )}
                                    {toggles.stepRiser && (
                                        isBackCleat
                                        ? <DatumTriangle x={params.stepWidth} y={remThickness + params.stepDepth/2} direction="right" />
                                        : <DatumTriangle x={params.stepWidth} y={params.stepDepth/2} direction="right" />
                                    )}
                                    {toggles.topFace && (
                                        isBackCleat
                                        ? <DatumTriangle x={params.totalWidth/2} y={0} direction="down" />
                                        : <DatumTriangle x={(params.stepWidth + params.totalWidth)/2} y={0} direction="down" />
                                    )}
                                </svg>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CleatGenerator />);
    </script>
</body>
</html>
